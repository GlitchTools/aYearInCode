
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">

		<script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.4/p5.js"></script>
		<!-- uncomment lines below to include extra p5 libraries -->
		<!--<script language="javascript" src="../addons/p5.dom.js"></script>-->
		<!--<script language="javascript" src="../addons/p5.sound.js"></script>-->
		<!-- this line removes any default padding and style. you might only need one of these values set. -->
		<style> body {padding: 0; margin: 0;} </style>
	</head>

	<body>
		<script language="javascript" type="text/javascript">

		// code by Phillip Stearns for image processing via pixel pushing
		// This work is licensed under the Creative Commons Attribution-NonCommercial 4.0 International License.
		// To view a copy of this license, visit http://creativecommons.org/licenses/by-nc/4.0/.
		// contact phil@phillipstearns.com

		// things to implement:
		// user specified image
		// import vector matrix
		// export vector matrix
		// gui for control of matrix parameters
		// gui for control of p5.Image.copy() parameters
		// save image
		// pause/resume

		// type 'a' to reset image
		// type 'r' to randomize the grid


		var imgSrc;
		var imgBuffer;
		var imgDisplay;

		var x;
		var y;
		var update;

		var blocksHigh;
		var blocksWide;

		var blocks = [];
		
		function preload(){
			imgSrc = loadImage("https://upload.wikimedia.org/wikipedia/commons/5/54/Landscape_of_Shadegan.jpg");
		}

		function setup() {

			devicePixelScaling(false);
			imgBuffer = createImage(imgSrc.width, imgSrc.height);
			imgDisplay = createImage(imgSrc.width, imgSrc.height);
			loadBuffer(imgSrc);
			displayBuffer();

			makeBlocks(10, 12);

			createCanvas(imgSrc.width, imgSrc.height);
			x=0;
			y=0;
			update = false;
			image(imgDisplay, 0, 0);


		}

		function draw() {

			// swaps lines and columns of pixels across the center of the image
			// if(update==true){
			// 	imgBuffer.loadPixels();
			// 	swapLines(y%height,(imgBuffer.height-1)-(y%imgBuffer.height));
			// 	swapCols(x%width,(imgBuffer.width-1)-(x%imgBuffer.width));
			// 	imgBuffer.updatePixels();
			// 	displayBuffer();				
		 //  	}

		  	var angle = random(.01);
		  	for(var i = 0 ; i < blocks.length ; i++){

		  		var newVector = new p5.Vector.sub(blocks[i].position, blocks[i].origin);
		  		newVector.rotate(angle+random(.01));
		  		newVector.setMag(2);
		  		blocks[i].position = p5.Vector.add(blocks[i].origin, newVector);
		  		displaceBlock(blocks[i]);
		  		
		  	}
			displayBuffer();
		  	
		  	image(imgDisplay, 0, 0); 
		}

		function keyTyped() {
			if (key === 'a') {
				loadBuffer(imgSrc);
				displayBuffer();
			}
			if (key === 'r') {
				makeBlocks(int(random(20))+2, int(random(20))+2);
			}
			return false; // prevent any default behavior
		}

		function touchStarted() {
			x = touchX;
			y = touchY;
			update=true;
			return false;
		}

		function mousePressed() {
			
			x = mouseX;
			y = mouseY;
			update=true;
			return false;
		}

		function touchMoved(){
			if(touchIsDown){
				x = touchX;
				y = touchY;
			} else if(mouseIsPressed){
				x = mouseX;
				y = mouseY;
			}
			update=true
		}

		function touchEnded(){
			update=false;
			return false;
		}

		function makeBlocks(_blocksWide, _blocksHigh){

			blocks=[];
			blocksHigh = _blocksHigh;
			blocksWide = _blocksWide;
			blockWidth = int(imgBuffer.width/blocksWide)+1;
			blockHeight = int(imgBuffer.height/blocksHigh)+1;

			var index = 0;
			for(var y = 0 ; y < blocksHigh; y++){
				for(var x = 0 ; x < blocksWide; x++){
					blocks[index++]= new Block(10, x*blockWidth, y*blockHeight, blockWidth, blockHeight);
				}
			}
		}

		function swapLines(lineA, lineB){
			for(var i = 0 ; i < imgBuffer.width ; i++){
				for(var j = 0 ; j < 4 ; j++){
					var buffer = imgBuffer.pixels[4*(lineA*imgBuffer.width+i)+j];
					imgBuffer.pixels[4*(lineA*imgBuffer.width+i)+j] = imgBuffer.pixels[4*(lineB*imgBuffer.width+i)+j];
					imgBuffer.pixels[4*(lineB*imgBuffer.width+i)+j] = buffer;
				}
			}
		}

		function swapCols(colA, colB){
			for(var i = 0 ; i < imgBuffer.height ; i++){
				for(var j = 0 ; j < 4 ; j++){
					var buffer = imgBuffer.pixels[4*(i*imgBuffer.width+colA)+j];
					imgBuffer.pixels[4*(i*imgBuffer.width+colA)+j] = imgBuffer.pixels[4*(i*imgBuffer.width+colB)+j];
					imgBuffer.pixels[4*(i*imgBuffer.width+colB)+j] = buffer;
				}
			}
		}

		function swapPixels(pixels){
			var pixelsToSwap = pixels;
			for(var i = 0 ; i < pixelsToSwap ; i++){
				swapPixel();
			}
		}

		function swapPixel(){
			var sourceX = int(random(imgBuffer.width));
			var sourceY = int(random(imgBuffer.height));
			var destX = int(random(imgBuffer.width));
			var destY = int(random(imgBuffer.height));

			for(var i = 0 ; i < 4 ; i++){
				var buffer = imgBuffer.pixels[4*(sourceY*imgBuffer.width+sourceX)+i];
				imgBuffer.pixels[4*(sourceY*imgBuffer.width+sourceX)+i]  = imgBuffer.pixels[4*(destY*imgBuffer.width+destX)+i];
				imgBuffer.pixels[4*(destY*imgBuffer.width+destX)+i] = buffer;
			}
		}

		function loadBuffer(image){

			image.loadPixels();
			imgBuffer.loadPixels();

			for(var i = 0 ; i < imgSrc.pixels.length ; i++){
				imgBuffer.pixels[i] = image.pixels[i];	
			}

		 	imgBuffer.updatePixels();

		}

		function displayBuffer(){

			imgDisplay.loadPixels();
			imgBuffer.loadPixels();

			for(var i = 0 ; i < imgSrc.pixels.length ; i++){
				imgDisplay.pixels[i] = imgBuffer.pixels[i];	
			}

		  	imgDisplay.updatePixels();
		}

		//begin imgBlock definition

		function Block(m, x, y, w, h){

			this.mass = m;
			this.origin = createVector(x,y);
			this.position = createVector(x+random(-5,5),y+random(-5,5));
			this.velocity = createVector(0,0);
			this.acceleration = createVector(0,0);
			this.width = w;
			this.height = h;

			this.applyForce = function(force){
				var f = p5.Vector.div(force,this.mass);
	  			this.acceleration.add(f);
			}

			this.update = function(){
				this.velocity.add(this.acceleration);
				this.position.add(this.velocity);
				this.acceleration.mult(0);
			}

			this.get = function(){
				return this;
			}

		}		

		function displaceBlock(the_block){

			var b = the_block.get();
			var sx =b.origin.x;
			var sy =b.origin.y;
			var sw =b.width;
			var sh =b.height;
			var dx =int(b.position.x); // using floating point engages interpolation which blurs the copy
			var dy =int(b.position.y); // using floating point engages interpolation which blurs the copy
			var dw =b.width;
			var dh =b.height;

			//copies pixels from the displayed image to the buffer
			imgBuffer.copy(imgDisplay,sx,sy,sw,sh,dx,dy,dw,dh);

		}


		</script>
	</body>
</html>
