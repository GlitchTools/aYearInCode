
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
		<script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.4/p5.js"></script>
		<!-- uncomment lines below to include extra p5 libraries -->
		<!--<script language="javascript" src="../addons/p5.dom.js"></script>-->
		<!--<script language="javascript" src="../addons/p5.sound.js"></script>-->
		<!-- this line removes any default padding and style. you might only need one of these values set. -->
		<style> body {padding: 0; margin: 0;} </style>
	</head>

	<body>
		<script language="javascript" type="text/javascript">

		var imgSrc;
		var imgBuffer;
		var imgDisplay;

		var x;
		var y;
		var update;

		var block;
		var blocksHigh;
		var blocksWide;

		var blocks = [];
		
		function preload(){
			imgSrc = loadImage("https://upload.wikimedia.org/wikipedia/commons/5/54/Landscape_of_Shadegan.jpg");
		}

		function setup() {

			devicePixelScaling(false);
			imgBuffer = createImage(imgSrc.width, imgSrc.height);
			imgDisplay = createImage(imgSrc.width, imgSrc.height);
			loadBuffer(imgSrc);
			displayBuffer();

			block = new Block(10, imgSrc.width/2, imgSrc.height/2, 50, 50);

			blocksHigh = 10;
			blocksWide = 10;
			blockWidth = int(imgBuffer.width/blocksWide);
			blockHeight = int(imgBuffer.height/blocksHigh);

			var index = 0;
			for(var y = 0 ; y < blocksHigh; y++){
				for(var x = 0 ; x < blocksWide; x++){
					blocks[index++]= new Block(10, x*blockWidth, y*blockHeight, blockWidth, blockHeight);
				}
			}

			position = createVector(0,0);
			//createCanvas(800, 600);
			createCanvas(imgSrc.width, imgSrc.height);
			x=0;
			y=0;
			update = false;
			image(imgDisplay, position.x, position.y);

		}

		function draw() {

			
			// swapPixels(125);

			if(update==true){
				imgBuffer.loadPixels();
				swapLines(y%height,(imgBuffer.height-1)-(y%imgBuffer.height));
				swapCols(x%width,(imgBuffer.width-1)-(x%imgBuffer.width));
				imgBuffer.updatePixels();
				
		  	}

		  	var newVector = new p5.Vector.sub(block.position, block.origin);
		  	newVector.rotate(.1);
		  	block.position = p5.Vector.add(block.origin, newVector);
		  	
		  	for(var i = 0 ; i < blocks.length ; i++){

		  		var newVector = new p5.Vector.sub(blocks[i].position, blocks[i].origin);
		  		newVector.rotate(.05);
		  		blocks[i].position = p5.Vector.add(blocks[i].origin, newVector);
		  		displaceBlock(blocks[i]);
		  	}

			// displaceBlock(block);

		 	

		

		  	displayBuffer();
		  	
		  	image(imgDisplay, 0, 0);

		  

		  
		}

		function keyTyped() {
			if (key === 'a') {
				loadBuffer(imgSrc);
			}
			return false; // prevent any default behavior
		}

		function touchStarted() {
			x = touchX;
			y = touchY;
			update=true;
			return false;
		}

		function mousePressed() {
			
			x = mouseX;
			y = mouseY;
			update=true;
			return false;
		}

		function touchMoved(){
			if(touchIsDown){
				x = touchX;
				y = touchY;
			} else if(mouseIsPressed){
				x = mouseX;
				y = mouseY;
			}
			update=true
		}

		function touchEnded(){
			update=false;
			return false;
		}

		function swapLines(lineA, lineB){
			for(var i = 0 ; i < imgBuffer.width ; i++){
				for(var j = 0 ; j < 4 ; j++){
					var buffer = imgBuffer.pixels[4*(lineA*imgBuffer.width+i)+j];
					imgBuffer.pixels[4*(lineA*imgBuffer.width+i)+j] = imgBuffer.pixels[4*(lineB*imgBuffer.width+i)+j];
					imgBuffer.pixels[4*(lineB*imgBuffer.width+i)+j] = buffer;
				}
			}
		}

		function swapCols(colA, colB){
			for(var i = 0 ; i < imgBuffer.height ; i++){
				for(var j = 0 ; j < 4 ; j++){
					var buffer = imgBuffer.pixels[4*(i*imgBuffer.width+colA)+j];
					imgBuffer.pixels[4*(i*imgBuffer.width+colA)+j] = imgBuffer.pixels[4*(i*imgBuffer.width+colB)+j];
					imgBuffer.pixels[4*(i*imgBuffer.width+colB)+j] = buffer;
				}
			}
		}

		function swapPixels(pixels){
			var pixelsToSwap = pixels;
			for(var i = 0 ; i < pixelsToSwap ; i++){
				swapPixel();
			}
		}

		function swapPixel(){
			var sourceX = int(random(imgBuffer.width));
			var sourceY = int(random(imgBuffer.height));

			var destX = int(random(imgBuffer.width));
			var destY = int(random(imgBuffer.height));

			for(var i = 0 ; i < 4 ; i++){
				var buffer = imgBuffer.pixels[4*(sourceY*imgBuffer.width+sourceX)+i];
				imgBuffer.pixels[4*(sourceY*imgBuffer.width+sourceX)+i]  = imgBuffer.pixels[4*(destY*imgBuffer.width+destX)+i];
				imgBuffer.pixels[4*(destY*imgBuffer.width+destX)+i] = buffer;
			}
		}

		function loadBuffer(image){
			image.loadPixels();
			imgBuffer.loadPixels();
			for(var i = 0 ; i < imgSrc.pixels.length ; i++){
				imgBuffer.pixels[i] = image.pixels[i];	
			}
		  	
		 	// arrayCopy(image.pixels, 0, imgBuffer.pixels, 0, image.pixels.length);

		 	imgBuffer.updatePixels();
		}

		function displayBuffer(){
			imgDisplay.loadPixels();
			imgBuffer.loadPixels();
			for(var i = 0 ; i < imgSrc.pixels.length ; i++){
				imgDisplay.pixels[i] = imgBuffer.pixels[i];	
			}
		  	imgDisplay.updatePixels();
		}

		//begin imgBlock definition

		function Block(m, x, y, w, h){

			this.mass = m;
			this.origin = createVector(x,y);
			this.position = createVector(x+random(-5,5),y+random(-5,5));
			this.velocity = createVector(0,0);
			this.acceleration = createVector(0,0);
			this.width = w;
			this.height = h;

			this.applyForce = function(force){
				var f = p5.Vector.div(force,this.mass);
	  			this.acceleration.add(f);
			}

			this.update = function(){
				this.velocity.add(this.acceleration);
				this.position.add(this.velocity);
				this.acceleration.mult(0);
			}

			this.get = function(){
				return this;
			}

		}

		

		

		function displaceBlock(the_block){
			var b = the_block.get();
			var sx =b.origin.x;
			var sy =b.origin.y;
			var sw =b.width;
			var sh =b.height;
			var dx =b.position.x;
			var dy =b.position.y;
			var dw =b.width;
			var dh =b.height;

			imgBuffer.copy(imgDisplay,sx,sy,sw,sh,dx,dy,dw,dh);

		}


		</script>
	</body>
</html>
